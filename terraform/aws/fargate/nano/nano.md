# EC2 Nano Setup
To run a much cheaper version of this infrastrucutre the ALB and the Database were replaced with a `t3a.nano`. This file aims to explain how the server is setup, how it carries out these two functions and how it's linked into the terraform setup.

## Base setup
The server is running the AWS Marketplace provided Ubuntu 18.04 image. An ssh key was generated to allow remote login access to the server.

### VPC
The nano is placed inside the same VPC as the ECS clusters. It has an assigned public IP (might be best to get an ElasticIP).
It lives in a public subnet of the VPC that's generated by terraform.

### Security Groups
Attached to the server are the following security group rules:
| Ports	| Protocol | Source          |
| ----- | -------- | --------------- |
| 22	  | tcp      | 0.0.0.0/0, ::/0 |
| 80	  | tcp      | 0.0.0.0/0, ::/0 |
| 443	  | tcp	     | 0.0.0.0/0, ::/0 |
| 5432	| tcp      | 0.0.0.0/0, ::/0 |

The `aws_security_group.ecs_tasks` sercurity group resource has also had an `ingress` rule attached to it to allow incoming connections only from the nano server on port `3000`

## ALB Replacement (Nginx Reverse Proxy)
The ALB is replaced by a simple Nginx reverse proxy by utilising AWS Service Discovery (see `../service_discovery.tf`). A registery is created that manages a private DNS namespace in Route53 (`bookings_production.internal`). This is attached to the ECS cluster (see `aws_ecs_service.main` resource). Every time a new container is spun up, an `A` record is created in this namespace with the name `_bookings_production_service.bookings_production.internal.`. We then instruct Nginx to do a simple round robin on these IPs to load balance the requests. AWS takes care of registering and deregistering the IPs for us.

_Known Issue_: If all tasks are shut down currently it takes ~15mins before the EC2 instance recognizes the new IPs are available in the network despite all the TTLs being set to 10s. Doing an `nslookup` will return no records. In order to try to solve this some `aws_vpc_dhcp_options` were created and attached to the VPC to try and make it watch for changes, this didn't seem to improve the time. This should be, however, a rare case that all tasks disspear at once. For this reason I support having at least 2 tasks running.

### Reverse Proxy Setup

First install Nginx:
```
sudo apt update
sudo apt install nginx
```

Disable the default virtual host, that is pre-configured when Nginx is installed via Ubuntuâ€™s package manager apt:
```
unlink /etc/nginx/sites-enabled/default
```

Now setup the reverse proxy configuration
```
sudo vim /etc/nginx/sites-enabled/reverse-proxy.conf
```
Take a look in `./reverse-proxy.conf` for the setup

_P.S. For the resolver you may need to do a `dig bookings_production.internal` to find the correct nameserver IP if it has changed_

Copy the configuration from `/etc/nginx/sites-available` to `/etc/nginx/sites-enabled` with a symbolic link:
```
ln -s /etc/nginx/sites-available/reverse-proxy.conf /etc/nginx/sites-enabled/reverse-proxy.conf
```

Test the file with `sudo nginx -t` and then restart with `sudo service nginx restart`. Now we can access the API from the public IP of the EC2 server. An `A` name record for the IP was placed in the `one.com` registrar under `api.company.org` to link to our domain name.

_P.S. Test will probably fail until you setup HTTPS certs below_

### TLS Setup with Let's Encrypt
Install Certbot:
```
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install python-certbot-nginx
```

Run the certbot prompts and enter the domain name you created the `A` record for earlier
```
sudo certbot --nginx
```

### Integration with Terraform
The only thing needed to hook in with the terraform setup is to make sure that the proxy security group ID is provided as a `local` variable called `proxy_sg_id` the `../variables.tf` file.

## RDS Replacement (PostgreSQL Database)
To avoid the huge costs of RDS with AWS we setup the database on the same nano. We don't expect a huge amount of load so this should do. Should we need to updgrade we can either go vertically with this server or we migrate back to the RDS instance and uncomment the code.

### PostgreSQL Setup
First install:
```
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib
```

Then we create the `booking` user and corresponding database
```
sudo -u postgres createuser booking
sudo -u postgres createdb booking
```

Give that user a password and grant them permissions to access their database:
```
sudo -u postgres psql
psql=# ALTER USER booking WITH ENCRYPTER PASSWORD 'REDACTED';
psql=# GRANT ALL PRIVILEGES ON DATABASE booking TO booking;
```

Seeing as we want to connect from another machine we need to tell PostgreSQL to listen to all addresses and allow a TCP connection for the booking user only

First uncomment and change the `#listen_addresses = 'localhost'` line in the `/etc/postgresql/10/main/postgresql.conf` file to:
```
listen_addresses = '*'
```
To allow the server to listen to all connections

Then we need to change the `/etc/postgresql/10/main/pg_hba.conf` to let the `booking` user to login from any IP (could constrict to local network if we don't want to be able to log in direct to the database ourselves). Add the following to the bottom of the file:
```
# Allow booking user access over socket
host    booking      booking      0.0.0.0/0               md5
```

Finally restart the service:
```
sudo systemctl restart postgresql.service
```

You can test the login locally by specifying `localhost` as the host:
```
sudo psql -h localhost -U booking -d booking -W
```

### Integration with Terraform
The only thing needed to connect the database with terraform is to set the `PG env` vars. As long as those vars match the values used during setup (username, database name, password, port etc) then all will be good. The `PGHOST` is the EC2 server IP.

## Resources
- https://tamas.dev/aws/ecs/haproxy/nginx/certbot/microservices/containers/route53/dns/srv/2019/10/18/run-your-ecs-cluster-with-service-discovery-and-haproxy-for-8-a-month.html
- https://www.scaleway.com/en/docs/how-to-configure-nginx-reverse-proxy/
- https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-18-04
- https://gist.github.com/AtulKsol/4470d377b448e56468baef85af7fd614
- https://help.ubuntu.com/stable/serverguide/postgresql.html